name: Keep Streamlit Awake

# Trigger workflow every 10 minutes and manually
on:
  schedule:
    - cron: '*/10 * * * *'   # every 10 minutes
  workflow_dispatch: {}       # allows manual trigger

jobs:
  keep-awake:
    runs-on: ubuntu-latest
    timeout-minutes: 15       # workflow timeout

    steps:
      # Step 2a: Checkout repo (needed for actions)
      - name: Checkout repo
        uses: actions/checkout@v4

      # Step 2b: Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # Step 2c: Install Puppeteer
      - name: Install Puppeteer
        run: |
          # create package.json if missing
          if [ ! -f package.json ]; then
            npm init -y
          fi
          npm i puppeteer@21 --no-audit --no-fund

      # Step 2d: Visit your Streamlit app
      - name: Run headless visit
        env:
          APP_URL: "https://q-adocuments.streamlit.app"   # your app URL
          WAIT_MS: "15000"   # 15 seconds wait
          NAV_TIMEOUT_MS: "90000"  # 90 seconds nav timeout
        run: |
          node <<'NODE'
          const puppeteer = require('puppeteer');
          const url = process.env.APP_URL;
          const waitMs = parseInt(process.env.WAIT_MS || '15000', 10);
          const navTimeout = parseInt(process.env.NAV_TIMEOUT_MS || '90000', 10);

          (async () => {
            console.log('Visiting', url);
            const browser = await puppeteer.launch({
              args: ['--no-sandbox', '--disable-setuid-sandbox', '--disable-dev-shm-usage']
            });
            const page = await browser.newPage();
            page.setDefaultNavigationTimeout(navTimeout);

            try {
              await page.goto(url, { waitUntil: 'networkidle2' });
              console.log('Page loaded, waiting', waitMs, 'ms...');
              await page.waitForTimeout(waitMs);

              // Optional: click any "Wake" / "Open" button
              const selectors = [
                'button:has-text("Wake")',
                'button:has-text("Wake app")',
                'button:has-text("Open")',
                'button:has-text("Continue")'
              ];

              for (const sel of selectors) {
                try {
                  const el = await page.$(sel);
                  if (el) {
                    console.log('Clicking selector:', sel);
                    await el.click();
                    await page.waitForTimeout(3000);
                    break;
                  }
                } catch {}
              }

              console.log('Visit complete.');
            } catch (err) {
              console.error('Visit failed:', err && err.message ? err.message : err);
              process.exitCode = 1;
            } finally {
              await browser.close();
            }
          })();
          NODE
